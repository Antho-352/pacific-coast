---
deployment:
  tasks:
    # DÃ©finition des variables
    - export DEPLOYPATH=/home/hondapacificcoas/public_html/
    - export REPO_PATH=/home/hondapacificcoas/repositories/pacific-coast/
    - export BACKUP_PATH=/tmp/magazine-backup-$(date +%s)
    
    # Log de dÃ©but
    - echo "[$(date)] ðŸš€ DÃ©marrage du dÃ©ploiement automatique" >> /home/hondapacificcoas/deploy.log
    
    # Ã‰tape 1 : SAUVEGARDE du dossier /magazine s'il existe
    - if [ -d "$DEPLOYPATH/magazine" ]; then echo "[$(date)] ðŸ’¾ Sauvegarde de /magazine..." >> /home/hondapacificcoas/deploy.log && mkdir -p $BACKUP_PATH && cp -R $DEPLOYPATH/magazine $BACKUP_PATH/ && echo "[$(date)] âœ… /magazine sauvegardÃ© dans $BACKUP_PATH" >> /home/hondapacificcoas/deploy.log; else echo "[$(date)] â„¹ï¸ Pas de /magazine Ã  sauvegarder" >> /home/hondapacificcoas/deploy.log; fi
    
    # Ã‰tape 2 : Installation des dÃ©pendances
    - cd $REPO_PATH && /opt/cpanel/ea-nodejs20/bin/npm install >> /home/hondapacificcoas/deploy.log 2>&1
    
    # Ã‰tape 3 : Build
    - cd $REPO_PATH && /opt/cpanel/ea-nodejs20/bin/npm run build >> /home/hondapacificcoas/deploy.log 2>&1
    
    # Ã‰tape 4 : DÃ©ploiement - suppression des fichiers Astro uniquement (pas les dossiers WordPress)
    - echo "[$(date)] ðŸ§¹ Nettoyage des anciens fichiers..." >> /home/hondapacificcoas/deploy.log
    - find $DEPLOYPATH -mindepth 1 -maxdepth 1 -type f -delete 2>/dev/null || true
    - find $DEPLOYPATH -mindepth 1 -maxdepth 1 -type d ! -name 'magazine' ! -name 'wp-content' ! -name 'wp-admin' ! -name 'wp-includes' -exec rm -rf {} + 2>/dev/null || true
    
    # Ã‰tape 5 : Copie des nouveaux fichiers
    - echo "[$(date)] ðŸ“ Copie des nouveaux fichiers..." >> /home/hondapacificcoas/deploy.log
    - cp -R $REPO_PATH/dist/* $DEPLOYPATH/
    
    # Ã‰tape 6 : RESTAURATION de /magazine
    - if [ -d "$BACKUP_PATH/magazine" ]; then echo "[$(date)] â™»ï¸ Restauration de /magazine..." >> /home/hondapacificcoas/deploy.log && rm -rf $DEPLOYPATH/magazine && cp -R $BACKUP_PATH/magazine $DEPLOYPATH/ && rm -rf $BACKUP_PATH && echo "[$(date)] âœ… /magazine restaurÃ© avec succÃ¨s" >> /home/hondapacificcoas/deploy.log; fi
    
    # Log de fin
    - echo "[$(date)] âœ… DÃ©ploiement terminÃ©" >> /home/hondapacificcoas/deploy.log
